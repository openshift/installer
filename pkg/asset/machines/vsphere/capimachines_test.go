package vsphere

import (
	"testing"

	"github.com/stretchr/testify/assert"

	"github.com/openshift/installer/pkg/ipnet"
	"github.com/openshift/installer/pkg/types"
)

// Generated by GPT-5.1

func TestDetectMachineNetworkIPFamilies(t *testing.T) {
	testCases := []struct {
		name    string
		config  *types.InstallConfig
		hasIPv4 bool
		hasIPv6 bool
	}{
		{
			name: "Networking is nil",
			config: &types.InstallConfig{
				Networking: nil,
			},
			hasIPv4: false,
			hasIPv6: false,
		},
		{
			name: "IPv4-only MachineNetwork",
			config: &types.InstallConfig{
				Networking: &types.Networking{
					MachineNetwork: []types.MachineNetworkEntry{
						{CIDR: *ipnet.MustParseCIDR("192.0.2.0/24")},
					},
				},
			},
			hasIPv4: true,
			hasIPv6: false,
		},
		{
			name: "IPv6-only MachineNetwork",
			config: &types.InstallConfig{
				Networking: &types.Networking{
					MachineNetwork: []types.MachineNetworkEntry{
						{CIDR: *ipnet.MustParseCIDR("2001:db8::/64")},
					},
				},
			},
			hasIPv4: false,
			hasIPv6: true,
		},
		{
			name: "Dual-stack MachineNetwork with IPv4 first",
			config: &types.InstallConfig{
				Networking: &types.Networking{
					MachineNetwork: []types.MachineNetworkEntry{
						{CIDR: *ipnet.MustParseCIDR("192.0.2.0/24")},
						{CIDR: *ipnet.MustParseCIDR("2001:db8::/64")},
					},
				},
			},
			hasIPv4: true,
			hasIPv6: true,
		},
		{
			name: "Dual-stack MachineNetwork with IPv6 first",
			config: &types.InstallConfig{
				Networking: &types.Networking{
					MachineNetwork: []types.MachineNetworkEntry{
						{CIDR: *ipnet.MustParseCIDR("2001:db8::/64")},
						{CIDR: *ipnet.MustParseCIDR("192.0.2.0/24")},
					},
				},
			},
			hasIPv4: true,
			hasIPv6: true,
		},
		{
			name: "IPv4-only DeprecatedMachineCIDR",
			config: &types.InstallConfig{
				Networking: &types.Networking{
					DeprecatedMachineCIDR: ipnet.MustParseCIDR("192.0.2.0/24"),
				},
			},
			hasIPv4: true,
			hasIPv6: false,
		},
		{
			name: "IPv6-only DeprecatedMachineCIDR",
			config: &types.InstallConfig{
				Networking: &types.Networking{
					DeprecatedMachineCIDR: ipnet.MustParseCIDR("2001:db8::/32"),
				},
			},
			hasIPv4: false,
			hasIPv6: true,
		},
		{
			name: "MachineNetwork IPv4 with DeprecatedMachineCIDR IPv6",
			config: &types.InstallConfig{
				Networking: &types.Networking{
					MachineNetwork: []types.MachineNetworkEntry{
						{CIDR: *ipnet.MustParseCIDR("192.0.2.0/24")},
					},
					DeprecatedMachineCIDR: ipnet.MustParseCIDR("2001:db8::/32"),
				},
			},
			hasIPv4: true,
			hasIPv6: true,
		},
		{
			name: "MachineNetwork IPv6 with DeprecatedMachineCIDR IPv4",
			config: &types.InstallConfig{
				Networking: &types.Networking{
					MachineNetwork: []types.MachineNetworkEntry{
						{CIDR: *ipnet.MustParseCIDR("2001:db8::/64")},
					},
					DeprecatedMachineCIDR: ipnet.MustParseCIDR("192.0.2.0/24"),
				},
			},
			hasIPv4: true,
			hasIPv6: true,
		},
		{
			name: "Empty MachineNetwork with DeprecatedMachineCIDR IPv4",
			config: &types.InstallConfig{
				Networking: &types.Networking{
					MachineNetwork:        []types.MachineNetworkEntry{},
					DeprecatedMachineCIDR: ipnet.MustParseCIDR("192.0.2.0/24"),
				},
			},
			hasIPv4: true,
			hasIPv6: false,
		},
		{
			name: "Empty MachineNetwork with DeprecatedMachineCIDR IPv6",
			config: &types.InstallConfig{
				Networking: &types.Networking{
					MachineNetwork:        []types.MachineNetworkEntry{},
					DeprecatedMachineCIDR: ipnet.MustParseCIDR("2001:db8::/32"),
				},
			},
			hasIPv4: false,
			hasIPv6: true,
		},
	}

	for _, tc := range testCases {
		t.Run(tc.name, func(t *testing.T) {
			hasIPv4, hasIPv6 := detectMachineNetworkIPFamilies(tc.config)
			assert.Equal(t, tc.hasIPv4, hasIPv4, "hasIPv4 mismatch")
			assert.Equal(t, tc.hasIPv6, hasIPv6, "hasIPv6 mismatch")
		})
	}
}
