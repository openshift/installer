#!/bin/bash

set -e

timeout=$((SECONDS + 30))

while [[ $SECONDS -lt $timeout ]]
do
     IS_NODE_ZERO=$(ip -j address | jq '[.[].addr_info] | flatten | map(.local=="{{.NodeZeroIP}}") | any')
     if [ "${IS_NODE_ZERO}" = "true" ]; then
          break
     fi
     sleep 5
done

if [ "${IS_NODE_ZERO}" = "true" ]; then
    echo "Node 0 IP {{.NodeZeroIP}} found on this host" 1>&2

    NODE0_PATH=/etc/assisted-service/node0
    mkdir -p "$(dirname "${NODE0_PATH}")"

    NODE_ZERO_MAC=$(ip -j address | jq -r '.[] | select(.addr_info | map(select(.local == "{{.NodeZeroIP}}")) | any).address')
    echo "MAC Address for Node 0: ${NODE_ZERO_MAC}"

    cat >"${NODE0_PATH}" <<EOF
BOOTSTRAP_HOST_MAC=${NODE_ZERO_MAC}
EOF

    echo "Created file ${NODE0_PATH}"

    rendezvousHostMessage="This host {{.NodeZeroIP}} is the rendezvous host."

    cat <<EOF >/etc/motd
The primary service is assisted-service.service. To watch its status, run:

  journalctl -u assisted-service.service
EOF
else

    rendezvousHostMessage="This host is not the rendezvous host. The rendezvous host is at {{.NodeZeroIP}}."
fi
mkdir -p /etc/motd.d/
echo $rendezvousHostMessage > /etc/motd.d/60-rendezvous-host
echo $rendezvousHostMessage > /etc/issue.d/60-rendezvous-host.issue
agetty --reload
