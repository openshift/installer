apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: master
  name: after-reboot
spec:
  config:
    ignition:
      version: 3.1.0
    storage:
      files:
        - contents:
            source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2ggLXgKZXhwb3J0IEtVQkVDT05GSUc9L2V0Yy9rdWJlcm5ldGVzL2Jvb3RzdHJhcC1zZWNyZXRzL2t1YmVjb25maWcKZnVuY3Rpb24gY29weV9maWxlIHsKICBFVENEX0RJUj0iL2Jvb3QvbWFzdGVyL2V0Y2QiCiAgZWNobyAiQ29weSAkRVRDRF9ESVIiCiAgaWYgWyAtZCAiJEVUQ0RfRElSIiBdOyB0aGVuCiAgICBjcCAtciAkRVRDRF9ESVIgL3Zhci9saWIKICAgIHJtIC1yZiAkRVRDRF9ESVIKICBmaQogIEtVQkVfRElSPSIvYm9vdC9tYXN0ZXIva3ViZXJuZXRlcy8iCiAgZWNobyAiQ29weSAkS1VCRV9ESVIiCiAgaWYgWyAtZCAiJEtVQkVfRElSIiBdOyB0aGVuCiAgICBjcCAtciAkS1VCRV9ESVIvKiAvZXRjL2t1YmVybmV0ZXMKICAgIHJtIC1yZiAkS1VCRV9ESVIKICBmaQp9CmZ1bmN0aW9uIHdhaXRfZm9yX2FwaSB7CiAgdW50aWwgb2MgZ2V0IGNzciAmPiAvZGV2L251bGwKICAgIGRvCiAgICAgICAgZWNobyAiV2FpdGluZyBmb3IgYXBpIC4uLiIKICAgICAgICBzbGVlcCAzMAogICAgZG9uZQp9CmZ1bmN0aW9uIHJlc3RhcnRfa3ViZWxldCB7CiAgZWNobyAiUmVzdGFydGluZyBrdWJlbGV0IgogIHdoaWxlIGNhdCAvZXRjL2t1YmVybmV0ZXMvbWFuaWZlc3RzL2t1YmUtYXBpc2VydmVyLXBvZC55YW1sICB8IGdyZXAgYm9vdHN0cmFwLWt1YmUtYXBpc2VydmVyOyBkbwogICAgZWNobyAiV2FpdGluZyBmb3Iga3ViZS1hcGlzZXJ2ZXIgdG8gYXBwbHkgdGhlIG5ldyBzdGF0aWMgcG9kIGNvbmZpZ3VyYXRpb24iCiAgICBzbGVlcCAxMAogIGRvbmUKICBzeXN0ZW1jdGwgZGFlbW9uLXJlbG9hZAogIHN5c3RlbWN0bCByZXN0YXJ0IGt1YmVsZXQKfQpmdW5jdGlvbiBhcHByb3ZlX2NzciB7CiAgZWNobyAiQXBwcm92aW5nIGNzcnMgLi4uIgogIG5lZWRlZF90b19hcHByb3ZlPWZhbHNlCiAgdW50aWwgWyAkKG9jIGdldCBub2RlcyB8IGdyZXAgbWFzdGVyIHwgZ3JlcCAtdiBOb3RSZWFkeSB8IGdyZXAgUmVhZHkgfCB3YyAtbCkgLWVxIDEgXTsgZG8KICAgICAgbmVlZGVkX3RvX2FwcHJvdmU9dHJ1ZQogICAgICBlY2hvICJBcHByb3ZpbmcgY3NycyAuLi4iCiAgICAgb2MgZ2V0IGNzciAtbyBnby10ZW1wbGF0ZT0ne3tyYW5nZSAuaXRlbXN9fXt7aWYgbm90IC5zdGF0dXN9fXt7Lm1ldGFkYXRhLm5hbWV9fXt7IlxuIn19e3tlbmR9fXt7ZW5kfX0nIHwgeGFyZ3Mgb2MgYWRtIGNlcnRpZmljYXRlIGFwcHJvdmUgJj4gL2Rldi9udWxsIHx8IHRydWUKICAgICBzbGVlcCAzMAogICAgZG9uZQojICAjIFJlc3RhcnQga3ViZWxldCBvbmx5IGlmIG5vZGUgd2FzIGFkZGVkCiMgIGlmICRuZWVkZWRfdG9fYXBwcm92ZSA7IHRoZW4KIyAgICBzbGVlcCA2MAojICAgIHJlc3RhcnRfa3ViZWxldAojICBmaQp9CmZ1bmN0aW9uIHdhaXRfZm9yX2N2byB7CiAgZWNobyAiV2FpdGluZyBmb3IgY3ZvIgogIHVudGlsIFsgIiQob2MgZ2V0IGNsdXN0ZXJ2ZXJzaW9uIC1vIGpzb25wYXRoPSd7Lml0ZW1zWzBdLnN0YXR1cy5jb25kaXRpb25zWz8oQC50eXBlPT0iQXZhaWxhYmxlIildLnN0YXR1c30nKSIgPT0gIlRydWUiIF07IGRvCiAgICAgIGVjaG8gIlN0aWxsIHdhaXRpbmcgZm9yIGN2byAuLi4iCiAgICAgc2xlZXAgMzAKICAgIGRvbmUKfQpmdW5jdGlvbiBjbGVhbiB7CiAgaWYgWyAtZCAiL2V0Yy9rdWJlcm5ldGVzL2Jvb3RzdHJhcC1zZWNyZXRzIiBdOyB0aGVuCiAgICAgcm0gLXJmIC9ldGMva3ViZXJuZXRlcy9ib290c3RyYXAtKgogIGZpCn0KY29weV9maWxlCndhaXRfZm9yX2FwaQphcHByb3ZlX2NzcgpyZXN0YXJ0X2t1YmVsZXQKd2FpdF9mb3JfY3ZvCmNsZWFu
          mode: 365
          overwrite: true
          path: /usr/local/bin/after_reboot.sh
    systemd:
      units:
        - name:  after_reboot.service
          contents: "[Unit]\nDescription=Master Install\nWants=kubelet.service\nAfter=kubelet.service\n[Service]\nType=oneshot\nExecStart=/usr/local/bin/after_reboot.sh\n\nRestartSec=5s\n\n[Install]\nWantedBy=multi-user.target\n"
          enabled: true
